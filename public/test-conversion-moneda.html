<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Conversi√≥n de Rangos USD/PEN seg√∫n Operaci√≥n</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #007cba;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .operation-toggle {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        .operation-btn {
            padding: 10px 20px;
            border: 2px solid #007cba;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: bold;
        }
        .operation-btn.active {
            background: #007cba;
            color: white;
        }
        .range-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        .range-active {
            background: #ffe066;
            border: 2px solid #ffc107;
            font-weight: bold;
        }
        .range-inactive {
            background: #f0f0f0;
            border: 1px solid #ddd;
        }
        .amount-input {
            padding: 10px;
            border: 2px solid #007cba;
            border-radius: 8px;
            font-size: 18px;
            width: 200px;
            margin: 10px;
        }
        .logic-explanation {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        .critical-values {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        .currency-info {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        button:hover {
            background: #005a8b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí± Test: Conversi√≥n de Rangos USD/PEN seg√∫n Operaci√≥n</h1>
        
        <div class="logic-explanation">
            <h3>üìã Nueva L√≥gica con Conversi√≥n de Moneda</h3>
            <ul>
                <li><strong>Rangos del cup√≥n:</strong> Siempre est√°n en USD (seg√∫n backend)</li>
                <li><strong>COMPRA:</strong> Usuario env√≠a USD ‚Üí Rangos se usan directamente</li>
                <li><strong>VENTA:</strong> Usuario env√≠a PEN ‚Üí Rangos se convierten de USD a PEN usando TC base</li>
            </ul>
            <p><strong>Ejemplo:</strong> Cup√≥n con rangos $1-$5000 y $5000-$20000 USD, TC base = 3.75</p>
            <ul>
                <li><strong>COMPRA:</strong> Rangos quedan $1-$5000 y $5000-$20000 USD</li>
                <li><strong>VENTA:</strong> Rangos se convierten a S/3.75-S/18,750 y S/18,750-S/75,000 PEN</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîÑ Tipo de Operaci√≥n</h3>
            <div class="operation-toggle">
                <button class="operation-btn active" onclick="setOperation('compra')" id="compraBtn">
                    COMPRA (Env√≠o USD)
                </button>
                <button class="operation-btn" onclick="setOperation('venta')" id="ventaBtn">
                    VENTA (Env√≠o PEN)
                </button>
            </div>
            
            <div class="currency-info" id="currencyInfo">
                <strong>üí∞ COMPRA:</strong> Tienes USD, quieres PEN. Rangos en USD.
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Probador Interactivo</h3>
            <div>
                <label id="amountLabel">üí∞ Monto a probar (USD): $</label>
                <input type="number" id="amountInput" class="amount-input" value="5000" step="0.01">
            </div>
            
            <div class="critical-values">
                <h4>‚ö° Valores Cr√≠ticos para Probar:</h4>
                <div id="testButtons">
                    <!-- Los botones se generar√°n din√°micamente -->
                </div>
            </div>

            <div id="rangeResults"></div>
        </div>

        <div class="test-section">
            <h3>üìä Resultados del Test</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        // üéØ DATOS DEL CUP√ìN REAL Y TC BASE
        const couponData = {
            codigo: "piza1",
            rangos: [
                { desde: 1, hasta: 5000, tc_compra: 3.556, tc_venta: 3.572 },
                { desde: 5000, hasta: 20000, tc_compra: 3.557, tc_venta: 3.571 }
            ]
        };
        
        const tcBase = { tc_compra: 3.750, tc_venta: 3.755 }; // TC base sin cup√≥n
        let currentOperation = 'compra';

        // üîÑ CAMBIAR TIPO DE OPERACI√ìN
        function setOperation(operation) {
            currentOperation = operation;
            
            // Actualizar botones
            document.getElementById('compraBtn').classList.toggle('active', operation === 'compra');
            document.getElementById('ventaBtn').classList.toggle('active', operation === 'venta');
            
            // Actualizar info de moneda
            const currencyInfo = document.getElementById('currencyInfo');
            const amountLabel = document.getElementById('amountLabel');
            
            if (operation === 'compra') {
                currencyInfo.innerHTML = '<strong>üí∞ COMPRA:</strong> Tienes USD, quieres PEN. Rangos en USD (directos).';
                amountLabel.textContent = 'üí∞ Monto a probar (USD): $';
            } else {
                currencyInfo.innerHTML = '<strong>üí∞ VENTA:</strong> Tienes PEN, quieres USD. Rangos convertidos a PEN usando TC base.';
                amountLabel.textContent = 'üí∞ Monto a probar (PEN): S/';
            }
            
            // Generar botones de prueba din√°micos
            generateTestButtons();
            
            // Actualizar display
            const amount = parseFloat(document.getElementById('amountInput').value) || 0;
            updateDisplay(amount);
        }

        // üéØ GENERAR BOTONES DE PRUEBA DIN√ÅMICOS
        function generateTestButtons() {
            const testButtons = document.getElementById('testButtons');
            
            if (currentOperation === 'compra') {
                // Para COMPRA: usar valores en USD
                testButtons.innerHTML = `
                    <button onclick="testAmount(4999)">$4,999 USD</button>
                    <button onclick="testAmount(5000)">$5,000 USD</button>
                    <button onclick="testAmount(5000.01)">$5,000.01 USD</button>
                    <button onclick="testAmount(1)">$1 USD</button>
                    <button onclick="testAmount(20000)">$20,000 USD</button>
                    <button onclick="testAmount(25000)">$25,000 USD</button>
                `;
            } else {
                // Para VENTA: usar valores convertidos a PEN
                const range1Max = 5000 * tcBase.tc_venta;
                const range2Max = 20000 * tcBase.tc_venta;
                testButtons.innerHTML = `
                    <button onclick="testAmount(${(range1Max - 1).toFixed(2)})">S/${(range1Max - 1).toLocaleString()} PEN</button>
                    <button onclick="testAmount(${range1Max})">S/${range1Max.toLocaleString()} PEN</button>
                    <button onclick="testAmount(${(range1Max + 1).toFixed(2)})">S/${(range1Max + 1).toLocaleString()} PEN</button>
                    <button onclick="testAmount(${(1 * tcBase.tc_venta).toFixed(2)})">S/${(1 * tcBase.tc_venta).toFixed(2)} PEN</button>
                    <button onclick="testAmount(${range2Max})">S/${range2Max.toLocaleString()} PEN</button>
                    <button onclick="testAmount(${(25000 * tcBase.tc_venta).toFixed(2)})">S/${(25000 * tcBase.tc_venta).toLocaleString()} PEN</button>
                `;
            }
        }

        // üîß L√ìGICA CORREGIDA CON CONVERSI√ìN DE MONEDA
        function findActiveRange(amount, rangos, operation) {
            // Filtrar rangos v√°lidos
            const rangosValidos = rangos.filter(r => {
                return r && r.desde != null && r.hasta != null;
            });

            let rangoActivo = null;
            const resultados = [];

            // Buscar el rango correcto con conversi√≥n de moneda
            for (let i = 0; i < rangosValidos.length; i++) {
                const rango = rangosValidos[i];
                const isLastRange = i === rangosValidos.length - 1;
                
                let minAmount = rango.desde;
                let maxAmount = rango.hasta;
                
                // üí± Si es VENTA, convertir rangos de USD a PEN usando TC base
                if (operation === 'venta') {
                    minAmount = minAmount * tcBase.tc_venta;
                    maxAmount = maxAmount * tcBase.tc_venta;
                }
                
                // üîß L√ìGICA CORREGIDA: Sin superposici√≥n de rangos
                // √öltimo rango incluye el l√≠mite superior, otros no
                const isInRange = isLastRange 
                    ? (amount >= minAmount && amount <= maxAmount)  // √öltimo: incluye l√≠mite superior
                    : (amount >= minAmount && amount < maxAmount);   // Otros: NO incluye l√≠mite superior
                
                resultados.push({
                    rango: rango,
                    minAmountOriginal: rango.desde,
                    maxAmountOriginal: rango.hasta,
                    minAmount,
                    maxAmount,
                    isLastRange,
                    isActive: isInRange,
                    logic: isLastRange ? `${minAmount.toFixed(2)} ‚â§ ${amount} ‚â§ ${maxAmount.toFixed(2)}` : `${minAmount.toFixed(2)} ‚â§ ${amount} < ${maxAmount.toFixed(2)}`,
                    evaluation: isLastRange ? `${amount >= minAmount} && ${amount <= maxAmount}` : `${amount >= minAmount} && ${amount < maxAmount}`
                });

                if (isInRange) {
                    rangoActivo = rango;
                }
            }

            return { rangoActivo, resultados };
        }

        // üé® ACTUALIZAR DISPLAY
        function updateDisplay(amount) {
            const { rangoActivo, resultados } = findActiveRange(amount, couponData.rangos, currentOperation);

            // Mostrar rangos
            const rangeResults = document.getElementById('rangeResults');
            let rangeHTML = '<h4>üìä Estado de los Rangos:</h4>';
            
            resultados.forEach((resultado, index) => {
                const activeClass = resultado.isActive ? 'range-active' : 'range-inactive';
                const checkMark = resultado.isActive ? ' ‚úÖ' : '';
                const currency = currentOperation === 'compra' ? 'USD' : 'PEN';
                const symbol = currentOperation === 'compra' ? '$' : 'S/';
                
                rangeHTML += `
                    <div class="${activeClass} range-item">
                        <span>
                            <strong>Rango ${index + 1}:</strong> 
                            ${symbol}${resultado.minAmount.toLocaleString()} - ${symbol}${resultado.maxAmount.toLocaleString()} ${currency}
                            ${checkMark}
                        </span>
                        <span>
                            TC: ${resultado.rango.tc_compra}/${resultado.rango.tc_venta}
                        </span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-left: 20px; margin-bottom: 10px;">
                        üìê Original: $${resultado.minAmountOriginal.toLocaleString()}-$${resultado.maxAmountOriginal.toLocaleString()} USD
                        ${currentOperation === 'venta' ? `‚Üí Convertido: S/${resultado.minAmount.toFixed(2)}-S/${resultado.maxAmount.toFixed(2)} PEN` : ''}
                    </div>
                    <div style="font-size: 12px; color: #666; margin-left: 20px; margin-bottom: 10px;">
                        üìê L√≥gica: ${resultado.logic} = ${resultado.evaluation} = ${resultado.isActive}
                        ${resultado.isLastRange ? ' (√öltimo rango - incluye l√≠mite superior)' : ' (No incluye l√≠mite superior)'}
                    </div>
                `;
            });

            rangeResults.innerHTML = rangeHTML;

            // Mostrar resultado final
            const testResults = document.getElementById('testResults');
            if (rangoActivo) {
                const currency = currentOperation === 'compra' ? 'USD' : 'PEN';
                const symbol = currentOperation === 'compra' ? '$' : 'S/';
                testResults.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #28a745; border-radius: 5px; padding: 15px;">
                        <h4>‚úÖ RESULTADO: Rango Encontrado</h4>
                        <p><strong>Operaci√≥n:</strong> ${currentOperation.toUpperCase()}</p>
                        <p><strong>Monto:</strong> ${symbol}${amount.toLocaleString()} ${currency}</p>
                        <p><strong>Rango original (USD):</strong> $${rangoActivo.desde.toLocaleString()} - $${rangoActivo.hasta.toLocaleString()}</p>
                        ${currentOperation === 'venta' ? 
                            `<p><strong>Rango convertido (PEN):</strong> S/${(rangoActivo.desde * tcBase.tc_venta).toFixed(2)} - S/${(rangoActivo.hasta * tcBase.tc_venta).toFixed(2)}</p>` 
                            : ''}
                        <p><strong>TC Compra:</strong> ${rangoActivo.tc_compra}</p>
                        <p><strong>TC Venta:</strong> ${rangoActivo.tc_venta}</p>
                    </div>
                `;
            } else {
                const currency = currentOperation === 'compra' ? 'USD' : 'PEN';
                const symbol = currentOperation === 'compra' ? '$' : 'S/';
                testResults.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 5px; padding: 15px;">
                        <h4>‚ùå RESULTADO: Ning√∫n Rango Aplica</h4>
                        <p><strong>Operaci√≥n:</strong> ${currentOperation.toUpperCase()}</p>
                        <p><strong>Monto:</strong> ${symbol}${amount.toLocaleString()} ${currency}</p>
                        <p>El monto est√° fuera de todos los rangos disponibles.</p>
                    </div>
                `;
            }
        }

        // üß™ FUNCI√ìN DE TEST
        function testAmount(amount) {
            document.getElementById('amountInput').value = amount;
            updateDisplay(amount);
        }

        // üìù EVENT LISTENER
        document.getElementById('amountInput').addEventListener('input', function(e) {
            const amount = parseFloat(e.target.value) || 0;
            updateDisplay(amount);
        });

        // üöÄ INICIALIZAR
        generateTestButtons();
        updateDisplay(5000);
        
        console.log('üéØ Test de conversi√≥n de rangos USD/PEN cargado');
        console.log('üìä Datos del cup√≥n:', couponData);
        console.log('üí± TC Base:', tcBase);
    </script>
</body>
</html>

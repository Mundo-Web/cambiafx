<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - L√≥gica CambiaFX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .result-box {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .error-box {
            background: #fdf2f2;
            border-left: 4px solid #dc2626;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .success-box {
            background: #f0fdf4;
            border-left: 4px solid #16a34a;
            padding: 1rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Test - L√≥gica CambiaFX Implementada</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üß† Funciones Implementadas seg√∫n Documentaci√≥n</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded">
                    <h3 class="font-semibold text-blue-800">‚úÖ isPenCurrency()</h3>
                    <p class="text-sm text-blue-600">Determina si el monto est√° en Soles (PEN)</p>
                </div>
                <div class="bg-green-50 p-4 rounded">
                    <h3 class="font-semibold text-green-800">‚úÖ getTcRangePEN()</h3>
                    <p class="text-sm text-green-600">Busca TC para montos en Soles</p>
                </div>
                <div class="bg-purple-50 p-4 rounded">
                    <h3 class="font-semibold text-purple-800">‚úÖ getTcRangeUSD()</h3>
                    <p class="text-sm text-purple-600">Busca TC para montos en D√≥lares</p>
                </div>
                <div class="bg-orange-50 p-4 rounded">
                    <h3 class="font-semibold text-orange-800">‚úÖ getTCFromAmount()</h3>
                    <p class="text-sm text-orange-600">Obtiene TC seg√∫n monto y origen</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üîÅ Funci√≥n Principal: calculateExchange()</h2>
            <div class="bg-yellow-50 p-4 rounded mb-4">
                <h3 class="font-semibold text-yellow-800">Flujo Implementado:</h3>
                <ol class="list-decimal list-inside text-sm text-yellow-700 mt-2">
                    <li><strong>Paso 1:</strong> Obtener el monto ingresado seg√∫n el origen</li>
                    <li><strong>Paso 2:</strong> Obtener el tipo de cambio correspondiente</li>
                    <li><strong>Paso 3:</strong> Calcular el monto convertido</li>
                    <li><strong>Paso 4:</strong> Mostrar resultado en el input contrario</li>
                </ol>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">üéØ Casos de Prueba</h2>
            <div id="test-results">
                <!-- Los resultados aparecer√°n aqu√≠ -->
            </div>
            <button onclick="runTests()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                üß™ Ejecutar Pruebas
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">üìã Documentaci√≥n Implementada</h2>
            <div class="prose max-w-none">
                <h3>üß† Conceptos Clave:</h3>
                <ul class="list-disc list-inside text-sm">
                    <li><strong>Origen (origin):</strong> 'O' = usuario ingresa en campo Transfiere, 'D' = usuario ingresa en campo Recibe</li>
                    <li><strong>isBuy:</strong> true = comprar d√≥lares (PEN ‚Üí USD), false = vender d√≥lares (USD ‚Üí PEN)</li>
                    <li><strong>isPenCurrency:</strong> Determina si el monto ingresado est√° en Soles seg√∫n operaci√≥n y origen</li>
                </ul>
                
                <h3 class="mt-4">üîÅ Flujo Principal:</h3>
                <div class="bg-gray-50 p-3 rounded text-sm font-mono">
                    <div>function calculateExchange(origin, inputValue) {</div>
                    <div class="ml-4">let amount = obtenerMonto(origin, inputValue)</div>
                    <div class="ml-4">let _tc = getTCFromAmount(amount, origin)</div>
                    <div class="ml-4">let total = calcularConversion(amount, _tc, origin)</div>
                    <div class="ml-4">mostrarResultado(total, origin)</div>
                    <div>}</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simulaci√≥n de datos para pruebas
        const mockTcData = [
            { id: 1, desde: 0, hasta: 1000, tc_compra: 3.5330, tc_venta: 3.5650 },
            { id: 2, desde: 1000, hasta: 5000, tc_compra: 3.5340, tc_venta: 3.5660 },
            { id: 3, desde: 5000, hasta: 10000, tc_compra: 3.5350, tc_venta: 3.5670 },
            { id: 4, desde: 10000, hasta: 999999, tc_compra: 3.5360, tc_venta: 3.5680 }
        ];

        // Implementaci√≥n de las funciones seg√∫n documentaci√≥n CambiaFX
        function isPenCurrency(origin = 'O', isBuy = false) {
            // CORRECCI√ìN FINAL:
            // VENTA = Usuario vende d√≥lares por soles (PEN ‚Üí USD) - ingresa soles, obtiene d√≥lares
            // COMPRA = Usuario compra d√≥lares con soles (USD ‚Üí PEN) - ingresa d√≥lares, obtiene soles
            const typeOperation = isBuy ? 'compra' : 'venta';
            
            if (typeOperation === 'venta' && origin === 'O') return true;  // PEN (input soles para obtener USD)
            if (typeOperation === 'compra' && origin === 'D') return true;   // PEN (recibe soles al ingresar USD)
            
            return false; // USD
        }

        function getTcRangePEN(dataRangesTc = [], amount = 0, isBuy = false) {
            const typeOperation = isBuy ? 'compra' : 'venta';
            if (!amount) return dataRangesTc[0] ?? null;

            for (const data of dataRangesTc) {
                const tc = typeOperation === 'compra' ? data.tc_compra : data.tc_venta;
                const amountUsd = Number((amount / tc).toFixed(2));

                if (amountUsd >= data.desde && amountUsd < data.hasta) return data;
            }
            return dataRangesTc[dataRangesTc.length - 1] ?? null;
        }

        function getTcRangeUSD(dataRangesTc = [], amount = 0) {
            let objTC = null;
            if (amount) {
                for (const obj of dataRangesTc) {
                    if (obj.desde <= amount && amount < obj.hasta) {
                        objTC = obj;
                        break;
                    }
                }
                objTC = objTC ?? (dataRangesTc[dataRangesTc.length - 1] ?? null);
            } else {
                objTC = dataRangesTc[0] ?? null;
            }
            return objTC;
        }

        function getTCFromAmount(amount, origin, isBuy) {
            const isPenCurrencyValue = isPenCurrency(origin, isBuy);
            const objTC = isPenCurrencyValue
                ? getTcRangePEN(mockTcData, amount, isBuy)
                : getTcRangeUSD(mockTcData, amount);

            if (!objTC) return 0;
            return isBuy ? objTC.tc_compra : objTC.tc_venta;
        }

        function calculateExchange(amount, origin, isBuy) {
            let total = 0;
            const _tc = getTCFromAmount(amount, origin, isBuy);

            // VENTA = soles ‚Üí d√≥lares (dividir por TC)
            // COMPRA = d√≥lares ‚Üí soles (multiplicar por TC)
            const isVenta = !isBuy; // isBuy=false significa VENTA

            if (origin === 'O') {
                total = isVenta ? amount / _tc : amount * _tc;
            } else if (origin === 'D') {
                total = isVenta ? amount * _tc : amount / _tc;
            }

            return {
                result: Math.round(total * 100) / 100,
                exchangeRate: _tc,
                isPen: isPenCurrency(origin, isBuy)
            };
        }

        function runTests() {
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = '';

            const tests = [
                // Pruebas de COMPRA (isBuy = true) - SOLES ‚Üí USD
                {
                    name: "COMPRA - 3533 PEN ‚Üí USD (origin='O')",
                    amount: 3533,
                    origin: 'O',
                    isBuy: true,
                    expected: "Usuario tiene soles, quiere comprar d√≥lares"
                },
                {
                    name: "COMPRA - 1000 USD ‚Üí PEN (origin='D')",
                    amount: 1000,
                    origin: 'D',
                    isBuy: true,
                    expected: "Usuario especifica cu√°ntos d√≥lares quiere recibir"
                },

                // Pruebas de VENTA (isBuy = false) - USD ‚Üí SOLES
                {
                    name: "VENTA - 500 USD ‚Üí PEN (origin='O')",
                    amount: 500,
                    origin: 'O',
                    isBuy: false,
                    expected: "Usuario tiene d√≥lares, quiere vender por soles"
                },
                {
                    name: "VENTA - 3565 PEN ‚Üí USD (origin='D')",
                    amount: 3565,
                    origin: 'D',
                    isBuy: false,
                    expected: "Usuario especifica cu√°ntos soles quiere recibir"
                }
            ];

            tests.forEach((test, index) => {
                try {
                    const result = calculateExchange(test.amount, test.origin, test.isBuy);
                    const isPenInput = isPenCurrency(test.origin, test.isBuy);
                    
                    testResults.innerHTML += `
                        <div class="success-box">
                            <h4 class="font-semibold text-green-800">‚úÖ Test ${index + 1}: ${test.name}</h4>
                            <p><strong>Input:</strong> ${test.amount} ${isPenInput ? 'PEN' : 'USD'}</p>
                            <p><strong>Resultado:</strong> ${result.result} ${isPenInput ? 'USD' : 'PEN'}</p>
                            <p><strong>Tipo de Cambio:</strong> ${result.exchangeRate}</p>
                            <p><strong>Es PEN?:</strong> ${result.isPen ? 'S√≠' : 'No'}</p>
                            <p class="text-sm text-gray-600">${test.expected}</p>
                        </div>
                    `;
                } catch (error) {
                    testResults.innerHTML += `
                        <div class="error-box">
                            <h4 class="font-semibold text-red-800">‚ùå Test ${index + 1}: ${test.name}</h4>
                            <p class="text-red-600">Error: ${error.message}</p>
                        </div>
                    `;
                }
            });

            // Prueba adicional: Verificar l√≥gica isPenCurrency
            testResults.innerHTML += `
                <div class="result-box">
                    <h4 class="font-semibold text-blue-800">üîç Verificaci√≥n isPenCurrency() - CORREGIDA</h4>
                    <p><strong>COMPRA (SOLES‚ÜíUSD):</strong></p>
                    <p>‚Ä¢ origin='O': ${isPenCurrency('O', true)} (deber√≠a ser true - usuario ingresa SOLES)</p>
                    <p>‚Ä¢ origin='D': ${isPenCurrency('D', true)} (deber√≠a ser false - usuario especifica USD que quiere)</p>
                    <p><strong>VENTA (USD‚ÜíSOLES):</strong></p>
                    <p>‚Ä¢ origin='O': ${isPenCurrency('O', false)} (deber√≠a ser false - usuario ingresa USD)</p>
                    <p>‚Ä¢ origin='D': ${isPenCurrency('D', false)} (deber√≠a ser true - usuario especifica SOLES que quiere)</p>
                </div>
            `;
        }

        // Ejecutar pruebas autom√°ticamente al cargar
        window.onload = function() {
            setTimeout(runTests, 500);
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cup√≥n PIZA1 - M√∫ltiples Rangos</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error {
            background: #ffe8e8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a8b;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Cup√≥n PIZA1 - M√∫ltiples Rangos</h1>
        <p><strong>Datos de tu API:</strong></p>
        <pre id="apiData">[
  {"idRange":3750,"tcFrom":1.000000,"tcTo":5000.000000,"tcBuy":3.550000,"tcSale":3.566000,"coupon":null,"amountMinOperation":0,"amountMaxOperation":0},
  {"idRange":3751,"tcFrom":5000.000000,"tcTo":20000.000000,"tcBuy":3.551000,"tcSale":3.565000,"coupon":null,"amountMinOperation":0,"amountMaxOperation":0}
]</pre>

        <div class="test-section">
            <h3>üîß Simulaci√≥n del CambiaFXService</h3>
            <div id="serviceResults"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Test de Rangos</h3>
            <div>
                <label>Monto USD: </label>
                <input type="number" id="testAmount" value="5000" placeholder="Ingresa monto...">
                <button onclick="testAmount()">Probar Monto</button>
            </div>
            <div>
                <button onclick="testSpecificAmount(4999)">Test: $4,999</button>
                <button onclick="testSpecificAmount(5000)">Test: $5,000 (L√çMITE)</button>
                <button onclick="testSpecificAmount(5001)">Test: $5,001</button>
                <button onclick="testSpecificAmount(10000)">Test: $10,000</button>
            </div>
            <div id="rangeResults"></div>
        </div>

        <div class="test-section">
            <h3>üìä Conversiones de Prueba</h3>
            <button onclick="testConversion(1000, 'V')">Test: 1000 USD ‚Üí PEN (Venta)</button>
            <button onclick="testConversion(6000, 'V')">Test: 6000 USD ‚Üí PEN (Venta)</button>
            <button onclick="testConversion(15000, 'V')">Test: 15000 USD ‚Üí PEN (Venta)</button>
            <div id="conversionResults"></div>
        </div>
    </div>

    <script>
        // Simular el CambiaFXService con los datos de tu API ACTUALIZADA
        const mockTcData = [
            { id: 3750, desde: 1, hasta: 5000, tc_compra: 3.560, tc_venta: 3.572 },
            { id: 3751, desde: 5000, hasta: 20000, tc_compra: 3.561, tc_venta: 3.571 }
        ];

        function getTCFromAmount(amount, operationType) {
            console.log('üéØ getTCFromAmount:', { amount, operationType, tcData: mockTcData });
            
            let tcObj = null;
            
            // L√ìGICA CORREGIDA: Sin superposici√≥n en los rangos
            for (let i = 0; i < mockTcData.length; i++) {
                const obj = mockTcData[i];
                const isLastRange = i === mockTcData.length - 1;
                
                console.log('üîé Verificando rango:', { 
                    desde: obj.desde, 
                    hasta: obj.hasta, 
                    monto: amount,
                    isLastRange 
                });
                
                // L√≥gica de rangos sin superposici√≥n:
                // Primer rango: desde <= amount < hasta (no incluye el l√≠mite superior)
                // √öltimo rango: desde <= amount <= hasta (incluye ambos l√≠mites)
                const isInRange = isLastRange 
                    ? (obj.desde <= amount && amount <= obj.hasta)  // √öltimo rango incluye l√≠mite superior
                    : (obj.desde <= amount && amount < obj.hasta);   // Otros rangos NO incluyen l√≠mite superior
                
                if (isInRange) {
                    tcObj = obj;
                    console.log('‚úÖ Rango encontrado:', { 
                        rango: tcObj, 
                        isLastRange, 
                        logicaUsada: isLastRange ? 'desde <= amount <= hasta' : 'desde <= amount < hasta'
                    });
                    break;
                }
            }
            
            // Si no se encuentra, usar el √∫ltimo rango
            if (tcObj === null) {
                tcObj = mockTcData[mockTcData.length - 1];
                console.log('üìä Usando √∫ltimo rango:', tcObj);
            }
            
            const tc = operationType === 'V' ? tcObj.tc_venta : tcObj.tc_compra;
            console.log('üéØ TC final seleccionado:', { tc, rango: tcObj });
            return { tc, rango: tcObj };
        }

        function testSpecificAmount(amount) {
            document.getElementById('testAmount').value = amount;
            testAmount();
        }

        function testAmount() {
            const amount = parseFloat(document.getElementById('testAmount').value) || 0;
            const resultContainer = document.getElementById('rangeResults');
            
            if (amount <= 0) {
                resultContainer.innerHTML = '<div class="error">‚ùå Ingresa un monto v√°lido</div>';
                return;
            }

            const ventaResult = getTCFromAmount(amount, 'V');
            const compraResult = getTCFromAmount(amount, 'C');

            resultContainer.innerHTML = `
                <div class="result">
                    <h4>üéØ Resultado para $${amount} USD:</h4>
                    <p><strong>VENTA:</strong> TC = ${ventaResult.tc} (Rango: $${ventaResult.rango.desde} - $${ventaResult.rango.hasta})</p>
                    <p><strong>COMPRA:</strong> TC = ${compraResult.tc} (Rango: $${compraResult.rango.desde} - $${compraResult.rango.hasta})</p>
                    <p><strong>Conversi√≥n VENTA:</strong> $${amount} ‚Üí S/ ${(amount * ventaResult.tc).toFixed(2)}</p>
                    <p><strong>Conversi√≥n COMPRA:</strong> $${amount} ‚Üí S/ ${(amount * compraResult.tc).toFixed(2)}</p>
                    ${amount === 5000 ? '<p style="color: red; font-weight: bold;">‚ö†Ô∏è CASO L√çMITE: $5000 debe usar el segundo rango (TC: 3.561/3.571)</p>' : ''}
                </div>
            `;
        }

        function testConversion(amount, operationType) {
            const result = getTCFromAmount(amount, operationType);
            const conversion = operationType === 'V' 
                ? (amount * result.tc).toFixed(2) 
                : (amount * result.tc).toFixed(2);
            
            const resultContainer = document.getElementById('conversionResults');
            resultContainer.innerHTML += `
                <div class="result">
                    <strong>$${amount} USD</strong> con operaci√≥n <strong>${operationType}</strong><br>
                    TC usado: <strong>${result.tc}</strong> (Rango: $${result.rango.desde} - $${result.rango.hasta})<br>
                    Resultado: <strong>S/ ${conversion}</strong>
                </div>
            `;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            const serviceContainer = document.getElementById('serviceResults');
            serviceContainer.innerHTML = `
                <div class="result">
                    <h4>üìä Datos procesados en tcData:</h4>
                    <pre>${JSON.stringify(mockTcData, null, 2)}</pre>
                    <p><strong>Total de rangos:</strong> ${mockTcData.length}</p>
                    <p><strong>Rango 1:</strong> $1 ‚â§ monto < $5,000 (TC Compra: 3.560, TC Venta: 3.572)</p>
                    <p><strong>Rango 2:</strong> $5,000 ‚â§ monto ‚â§ $20,000 (TC Compra: 3.561, TC Venta: 3.571)</p>
                    <p style="color: red; font-weight: bold;">‚ö†Ô∏è REGLA: $5000 exacto debe usar Rango 2 (3.561/3.571)</p>
                </div>
            `;
            
            // Test autom√°tico inicial
            testAmount();
        });
    </script>
</body>
</html>
